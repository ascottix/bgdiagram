/*
Backgammon diagram generator
Copyright (c) 2024-2025 Alessandro Scotti
MIT License
*/
const CheckerRadius=25,CheckerSize=50,BorderWidth=2;function BgDiagramBuilder(t){const o=(t=t||{}).swapColors?-1:1,n=250,e=54,c=t.compact?0:25,s=768,i=554+2*c,[a,r]=t.homeOnLeft?[-357,357]:[357,-357],d=[],l="bgdiagram";function f(t){return t*o==1?"white":"black"}function u(t,o){return"number"==typeof o&&(o=f(o)),`${l}__${t}`+(o?" "+o.split(" ").map((o=>`${l}__${t}--${o}`)).join(" "):"")}function $(o){return t.homeOnLeft?(o>12?37:13)-o:o}function h(t,o){let n,e=0,c=248;if(t<0)e=a-15*Math.sign(a),n=-50==t?-1:1;else if(t%25==0)n=t?-1:1,c-=37.5;else{n=(t=$(t))<=12?1:-1,e=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1)+25}return[e,n*(c-50*o)]}function p(t){d.push(t)}function g(t,o,n,e,c,s){const i=20,a=n-t,r=e-o,d=Math.atan2(r,a),l=t+c*i*Math.cos(d),f=o+c*i*Math.sin(d),u=n-s*i*Math.cos(d),$=e-s*i*Math.sin(d),h=u-i*Math.cos(d),p=$-i*Math.sin(d),g=5*Math.sin(d),b=5*-Math.cos(d),m=12.5*Math.sin(d),y=12.5*-Math.cos(d);return[[l-g,f-b],[h-g,p-b],[h-m,p-y],[u,$],[h+m,p+y],[h+g,p+b],[l+g,f+b]]}function b(t,o,n,e,c){p(`<polygon points="${g(t,o,n,e,.1,0).map((t=>t.join(","))).join(" ")}" class="${u("arrow",c)}" />`)}function m(t){const o=t<=12?1:-1,n=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1),e=26*o,c=e+249*o;p(`<polygon points="${n},${c} ${n+50},${c} ${n+25},${e+25*o}" class="${u("point",t%2?"odd":"even")}" />`)}function y(t,o){const n=t<=12?1:-1,[e,c]=h(t,0);w(e,c+50*n*.82,o,"point")}function w(t,o,n,e){p(`<text x="${t}" y="${o}" class="${u("text",e)}">${n}</text>`)}function k(){const o=[];o.push(`viewBox="-386 ${-i/2} 772 ${i}"`),o.push('role="img"'),o.push('aria-label="Diagram of a backgammon game position"'),t.width&&o.push(`width="${t.width}"`.replace("#",772)),t.height&&o.push(`height="${t.height}"`.replace("#",i));const n=t.classNames||[];n.length&&o.push(`class="${n.join(" ")}"`),d.length=0,p(`<svg ${o.join(" ")}>`),function(){const t=384,o=-275;p(`<rect x="-384" y="${-i/2}" width="768" height="${i}" class="${u("background")}"/>`),p(`<rect x="-384" y="-275" width="768" height="550" class="${u("board")}"/>`);for(let t=1;t<=24;t++)m(t);function n(t,o,n,e){p(`<rect x="${t}" y="${o}" width="${n}" height="550" class="${u("board-frame",e)}"/>`)}n(-27,o,e),n(-t,o,54),n(330,o,54),n(-t,o,s,"nofill")}()}return k(),Object.freeze({White:1,Black:-1,getBarPosition:function(t){return 1==t?25:0},getOffPosition:function(t){return 1==t?-25:-50},getCheckerCenter:h,getUsedCssStyles:function(){return new Set(["dominant-baseline","fill","fill-opacity","font-family","font-size","font-weight","stroke","stroke-opacity","stroke-width","text-anchor","transform"])},addArrow:function(t,o,n,e,c){const[s,i]=h(t,o),[a,r]=h(n,e);b(s,i,a,r,c)},addCheckers:function(o,n,e){const c="checker",s=n%25?5:4;for(let i=0;i<e;i++){const[a,r]=h(n,i);if(p(`<circle ${t.addPointInfo?`data-pt="${n}:${i}" `:""}cx="${a}" cy="${r}" r="23.9" class="${u(c,o)}" />`),i==s-1&&e>s){w(a,r,e,c+"--"+f(o));break}}},addCheckersOffboard:function(t,o){const e=a,c=t*n;for(let n=0;n<o;n++)p(`<rect x="${e-22.5}" y="${c-t*(n-1)*14-5}" width="45" height="10" ry="3" class="${u("checker",t)}"/>`);o&&p(`<text x="${e}" y="${c-t*o*14}" class="${u("text","offboard")}">${o}</text>`)},addCrawfordIndicator:function(){const t=r;w(t,-10,"CRAW","crawford"),w(t,10,"FORD","crawford")},addCube:function(t,o,e){const c=Math.round(20),s=r,i=t*(n+50*(e?1:-1)*.3-c);p(`<rect x="${s-c}" y="${i-c}" width="${2*c}" height="${2*c}" ry="4" class="${u("cube")}"/>`),w(s,i,o,"cube")},addDice:function(o,n,e){const c=(t.homeOnLeft?-1:1)*o*(152+50*e+2);function s(t,n){p(`<circle cx="${c+10*t}" cy="${10*n}" r="${50/12}" class="${u("dice-dot",o)}" />`)}p(`<rect x="${c-20}" y="-20" width="40" height="40" ry="6" class="${u("dice",o)}"/>`),1&n&&s(0,0),6&n&&(s(-1,-1),s(1,1)),4&n&&(s(-1,1),s(1,-1)),6==n&&(s(-1,0),s(1,0))},addDoubleArrow:function(t,o,n,e,c){const[s,i]=h(t,o),[a,r]=h(n,e);!function(t,o,n,e,c){const s=(n-t)/2,i=(e-o)/2,a=g(t+s,o+i,t,o,0,0),r=g(t+s,o+i,n,e,0,0);a.pop(),r.pop(),p(`<polygon points="${[...a,...r].map((t=>t.join(","))).join(" ")}" class="${u("arrow",c)}" />`)}(s,i,a,r,c)},addPipsCount:function(t,o){w(0,255*t,o,`pipcount ${f(t)}`)},addPlayerOnTurnIndicator:function(o,n){const e=[a,0,r][n||0],c=o*[289,254.5,150][n||0];if(n){const n=20,s=t.homeOnLeft?-1:1;b(e-s*n,c,e+s*n,c,f(o))}else p(`<circle cx="${e}" cy="${c}" r="10" class="${u("checker","turn "+f(o))}" />`)},addPointNumbers:function(t){for(let o=1;o<=24;o++){const n=$(o);y(n,1==t?n:25-n)}},addPointOverlay:function(t,o){const[n,e]=h(t,0);p(`<rect x="${n-25}" y="${Math.min(e-25,0)}" width="50" height="${273-(n%25?0:25)}" class="${u("point-overlay",o)}" />`)},addPolygon:function(t,o){const n="polygon";p(`<polygon points="${t=t.map((t=>h(t[0],t[1]).join(","))).join(" ")}" class="${u(n,"outer")}" />`),p(`<polygon points="${t}" class="${u(n,o)}" />`)},addScore:function(t,o){w(r,255*t,o,`${f(t)} score${o.length>3?" small":""}`)},addSvg:p,addText:w,close:function(){return p("</svg>"),d.join("")},reset:k})}export class BgDiagram{static newBuilder(t){return BgDiagramBuilder(t)}static getIsValidXgidRegEx(){const t="\\d+(\\.\\d+)?,\\d+(\\.\\d+)?",o="(\\d+|bar)\\/(\\d+|off)(\\*|\\([2-4]\\))?";return`^XGID=[-a-oA-O]{26}:\\d+:-?[01]:-?1:(00|[DBR]|[1-6]{2}):\\d+:\\d+:[0-3]:\\d+:\\d+(:(${`${o}(,${o})*[!?]*`}|${`[AD]${t}-${t}`}|${`P${t}(-${t})*`}|${`T${t}-[^:]+`}))*$`}static fromXgid(t,o){t="XGID=---ABCD------------bbbbb--:0:0:1:00:0:0:0:0:6:P6,0-6,3-3,0:P19,0-19,1-23,1-23,0:A5,4-5,3:A21,3-21,2:T0,4.5-Marked point x 10:T0,3.5-AAA";const n=o.builder||BgDiagramBuilder(o),e=n.White,c=n.Black,s="XGID=";t.startsWith(s)&&(t=t.substring(5));const i=t.split(":").slice(10);for(const t of i)if("O"==t[0]){const n=t[1],e=t.substring(2);"p"==n&&(o.__hidePipcount="-"==e)}const a=t.split(":").map(Number),r={[e]:0,[c]:0},d={[e]:0,[c]:0},l=new Array(26).fill(0);for(let o=0;o<=25;o++){let s=e,i=t.codePointAt(o)-64;i>0&&(i>15&&(i-=32,s=c),r[s]+=o*i,d[s]+=i,l[o]=i*s,n.addCheckers(s,o,i))}n.addCheckersOffboard(e,15-d[e]),n.addCheckersOffboard(c,15-d[c]);const f=a[3],u=null==o.turnIndicatorMode?o.compact?2:0:o.turnIndicatorMode;n.addPlayerOnTurnIndicator(f,u),!o.compact&&n.addPointNumbers(f);const $=a[8];if($>0){const t=o.scoreAsAway?$-a[5]+"a":`${a[5]}⧸${$}`,s=o.scoreAsAway?$-a[6]+"a":`${a[6]}⧸${$}`;n.addScore(e,t),n.addScore(c,s)}const h=a[1]||6,p=a[2];$>0&&a[7]?n.addCrawfordIndicator():n.addCube(p,1<<h,0==$?1:0);const g="annotation";function b(t){return t.substring(1).split("-").map((t=>t.split(",").map(Number)))}function m(t){let o,c=0;const s=t.match(/([!?]+)$/);s&&(o={"??":"blunder","?":"error","?!":"dubious","!":"good","!!":"best"}[s[0]],t=t.slice(0,-s[0].length));t.replace(/\*/g,"").replace(/bar/g,"25").replace(/\/off|\/0/g,`/${n.getOffPosition(f)}`).split(/\s*,\s*|\s+/).forEach((t=>{let s=1;const i=t.indexOf("(");i>0&&(s=parseInt(t.substring(i+1)),t=t.substring(0,i));for(let i=0;i<s;i++){const[a,r]=t.split("/").map((t=>t<0?t:f==e?parseInt(t):25-parseInt(t))),d=a>=1&&a<=24&&r>=1&&r<=24&&Math.sign(r-12)!=Math.sign(a-12),u=l[a]*f+(d?-1:2*i-s);if(r<0)n.addArrow(a,u,r,c++,o);else{l[r]*f<0&&(l[r]=0,l[n.getBarPosition(-f)]-=f);const t=Math.abs(l[r]);n.addArrow(a,u,r,t,o),l[r]+=f}l[a]-=f}}))}function y(t){const[[o,e],[c,s]]=b(t);n.addArrow(o,e,c,s,g)}function w(t){const[[o,e],[c,s]]=b(t);n.addDoubleArrow(o,e,c,s,g)}function k(t){const o=t.split("-"),[[e,c]]=b(o[0]),[s,i]=n.getCheckerCenter(e,c);n.addText(s,i,o[1],g)}for(const t of i)switch(t[0]){case"A":y(t);break;case"D":w(t);break;case"P":x=t,n.addPolygon(b(x),g);break;case"O":case"T":break;default:m(t)}var x;const A=Math.floor(a[4]/10),C=a[4]%10;A>=1&&A<=6&&C>=1&&C<=6&&(n.addDice(f,A,0),n.addDice(f,C,1)),o.__hidePipcount||(n.addPipsCount(e,r[e]),n.addPipsCount(c,25*d[c]-r[c]));for(const t of i)"T"==t[0]&&k(t);return n.close()}}