/*
Backgammon diagram generator
Copyright (c) 2024-2025 Alessandro Scotti
MIT License
*/
const CheckerRadius=25,CheckerSize=50,BorderWidth=2;function BgDiagramBuilder(t){const n=(t=t||{}).swapColors?-1:1,o=250,e=54,c=t.compact?0:25,s=768,a=554+2*c,[r,i]=t.homeOnLeft?[-357,357]:[357,-357],d=[],l="bgdiagram";function f(t){return t*n==1?"white":"black"}function u(t,n){return"number"==typeof n&&(n=f(n)),`${l}__${t}`+(n?" "+n.split(" ").map((n=>`${l}__${t}--${n}`)).join(" "):"")}function $(n){return t.homeOnLeft?(n>12?37:13)-n:n}function h(t,n){let o,e=0,c=248;if(t<0)e=r-15*Math.sign(r),o=-50==t?-1:1;else if(t%25==0)o=t?-1:1,c-=37.5;else{o=(t=$(t))<=12?1:-1,e=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1)+25}return[e,o*(c-50*n)]}function p(t){d.push(t)}function g(t,n,o,e,c,s){const a=20,r=o-t,i=e-n,d=Math.atan2(i,r),l=t+c*a*Math.cos(d),f=n+c*a*Math.sin(d),u=o-s*a*Math.cos(d),$=e-s*a*Math.sin(d),h=u-a*Math.cos(d),p=$-a*Math.sin(d),g=5*Math.sin(d),b=5*-Math.cos(d),m=12.5*Math.sin(d),y=12.5*-Math.cos(d);return[[l-g,f-b],[h-g,p-b],[h-m,p-y],[u,$],[h+m,p+y],[h+g,p+b],[l+g,f+b]]}function b(t,n,o,e,c){p(`<polygon points="${g(t,n,o,e,.1,0).map((t=>t.join(","))).join(" ")}" class="${u("arrow",c)}" />`)}function m(t){const n=t<=12?1:-1,o=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1),e=26*n,c=e+249*n;p(`<polygon points="${o},${c} ${o+50},${c} ${o+25},${e+25*n}" class="${u("point",t%2?"odd":"even")}" />`)}function y(t,n){const o=t<=12?1:-1,[e,c]=h(t,0);w(e,c+50*o*.82,n,"point")}function w(t,n,o,e){p(`<text x="${t}" y="${n}" class="${u("text",e)}">${o}</text>`)}function k(){const n=[];n.push(`viewBox="-386 ${-a/2} 772 ${a}"`),n.push('role="img"'),n.push('aria-label="Diagram of a backgammon game position"'),t.width&&n.push(`width="${t.width}"`.replace("#",772)),t.height&&n.push(`height="${t.height}"`.replace("#",a));const o=t.classNames||[];o.length&&n.push(`class="${o.join(" ")}"`),d.length=0,p(`<svg ${n.join(" ")}>`),function(){const t=384,n=-275;p(`<rect x="-384" y="${-a/2}" width="768" height="${a}" class="${u("background")}"/>`),p(`<rect x="-384" y="-275" width="768" height="550" class="${u("board")}"/>`);for(let t=1;t<=24;t++)m(t);function o(t,n,o,e){p(`<rect x="${t}" y="${n}" width="${o}" height="550" class="${u("board-frame",e)}"/>`)}o(-27,n,e),o(-t,n,54),o(330,n,54),o(-t,n,s,"nofill")}()}return k(),Object.freeze({White:1,Black:-1,getBarPosition:function(t){return 1==t?25:0},getOffPosition:function(t){return 1==t?-25:-50},getCheckerCenter:h,getUsedCssStyles:function(){return new Set(["dominant-baseline","fill","fill-opacity","font-family","font-size","font-weight","stroke","stroke-opacity","stroke-width","text-anchor","transform"])},addArrow:function(t,n,o,e,c){const[s,a]=h(t,n),[r,i]=h(o,e);b(s,a,r,i,c)},addCheckers:function(n,o,e){const c="checker",s=o%25?5:4;for(let a=0;a<e;a++){const[r,i]=h(o,a);if(p(`<circle ${t.addPointInfo?`data-pt="${o}:${a}" `:""}cx="${r}" cy="${i}" r="23.9" class="${u(c,n)}" />`),a==s-1&&e>s){w(r,i,e,c+"--"+f(n));break}}},addCheckersOffboard:function(t,n){const e=r,c=t*o;for(let o=0;o<n;o++)p(`<rect x="${e-22.5}" y="${c-t*(o-1)*14-5}" width="45" height="10" ry="3" class="${u("checker",t)}"/>`);n&&p(`<text x="${e}" y="${c-t*n*14}" class="${u("text","offboard")}">${n}</text>`)},addCrawfordIndicator:function(){const t=i;w(t,-10,"CRAW","crawford"),w(t,10,"FORD","crawford")},addCube:function(t,n,e){const c=Math.round(20),s=i,a=t*(o+50*(e?1:-1)*.3-c);p(`<rect x="${s-c}" y="${a-c}" width="${2*c}" height="${2*c}" ry="4" class="${u("cube")}"/>`),w(s,a,n,"cube")},addDice:function(n,o,e){const c=(t.homeOnLeft?-1:1)*n*(152+50*e+2);function s(t,o){p(`<circle cx="${c+10*t}" cy="${10*o}" r="${50/12}" class="${u("dice-dot",n)}" />`)}p(`<rect x="${c-20}" y="-20" width="40" height="40" ry="6" class="${u("dice",n)}"/>`),1&o&&s(0,0),6&o&&(s(-1,-1),s(1,1)),4&o&&(s(-1,1),s(1,-1)),6==o&&(s(-1,0),s(1,0))},addDoubleArrow:function(t,n,o,e,c){const[s,a]=h(t,n),[r,i]=h(o,e);!function(t,n,o,e,c){const s=(o-t)/2,a=(e-n)/2,r=g(t+s,n+a,t,n,0,0),i=g(t+s,n+a,o,e,0,0);r.pop(),i.pop(),p(`<polygon points="${[...r,...i].map((t=>t.join(","))).join(" ")}" class="${u("arrow",c)}" />`)}(s,a,r,i,c)},addPipsCount:function(t,n){w(0,255*t,n,`pipcount ${f(t)}`)},addPlayerOnTurnIndicator:function(n,o){const e=[r,0,i][o||0],c=n*[289,254.5,150][o||0];if(o){const o=20,s=t.homeOnLeft?-1:1;b(e-s*o,c,e+s*o,c,f(n))}else p(`<circle cx="${e}" cy="${c}" r="10" class="${u("checker","turn "+f(n))}" />`)},addPointNumbers:function(t){for(let n=1;n<=24;n++){const o=$(n);y(o,1==t?o:25-o)}},addPointOverlay:function(t,n){const[o,e]=h(t,0);p(`<rect x="${o-25}" y="${Math.min(e-25,0)}" width="50" height="${273-(o%25?0:25)}" class="${u("point-overlay",n)}" />`)},addPolygon:function(t,n){const o="polygon";p(`<polygon points="${t=t.map((t=>h(t[0],t[1]).join(","))).join(" ")}" class="${u(o,"outer")}" />`),p(`<polygon points="${t}" class="${u(o,n)}" />`)},addScore:function(t,n){w(i,255*t,n,`${f(t)} score${n.length>3?" small":""}`)},addSvg:p,addText:w,close:function(){return p("</svg>"),d.join("")},reset:k})}export class BgDiagram{static newBuilder(t){return BgDiagramBuilder(t)}static getIsValidXgidRegEx(){const t="\\d+(\\.\\d+)?,\\d+(\\.\\d+)?",n="(\\d+|bar)\\/(\\d+|off)(\\*|\\([2-4]\\))?";return`^XGID=[-a-oA-O]{26}:\\d+:-?[01]:-?1:(00|[DBR]|[1-6]{2}):\\d+:\\d+:[0-3]:\\d+:\\d+(:(${`${n}(,${n})*[!?]*`}|${`[AD]${t}-${t}`}|${`P${t}(-${t})*`}|${`T${t}-[^:]+`}))*$`}static fromXgid(t,n){const o=n.builder||BgDiagramBuilder(n),e=o.White,c=o.Black,s="XGID=";t.startsWith(s)&&(t=t.substring(5));const a=t.split(":").map(Number),r={[e]:0,[c]:0},i={[e]:0,[c]:0},d=new Array(26).fill(0);for(let n=0;n<=25;n++){let s=e,a=t.codePointAt(n)-64;a>0&&(a>15&&(a-=32,s=c),r[s]+=n*a,i[s]+=a,d[n]=a*s,o.addCheckers(s,n,a))}o.addCheckersOffboard(e,15-i[e]),o.addCheckersOffboard(c,15-i[c]);const l=a[3],f=null==n.turnIndicatorMode?n.compact?2:0:n.turnIndicatorMode;o.addPlayerOnTurnIndicator(l,f),!n.compact&&o.addPointNumbers(l);const u=a[8];if(u>0){const t=n.scoreAsAway?u-a[5]+"a":`${a[5]}⧸${u}`,s=n.scoreAsAway?u-a[6]+"a":`${a[6]}⧸${u}`;o.addScore(e,t),o.addScore(c,s)}const $=a[1]||6,h=a[2];u>0&&a[7]?o.addCrawfordIndicator():o.addCube(h,1<<$,0==u?1:0);const p="annotation";function g(t){return t.substring(1).split("-").map((t=>t.split(",").map(Number)))}function b(t){let n,c=0;const s=t.match(/([!?]+)$/);s&&(n={"??":"blunder","?":"error","?!":"dubious","!":"good","!!":"best"}[s[0]],t=t.slice(0,-s[0].length));t.replace(/\*/g,"").replace(/bar/g,"25").replace(/\/off|\/0/g,`/${o.getOffPosition(l)}`).split(/\s*,\s*|\s+/).forEach((t=>{let s=1;const a=t.indexOf("(");a>0&&(s=parseInt(t.substring(a+1)),t=t.substring(0,a));for(let a=0;a<s;a++){const[r,i]=t.split("/").map((t=>t<0?t:l==e?parseInt(t):25-parseInt(t))),f=r>=1&&r<=24&&i>=1&&i<=24&&Math.sign(i-12)!=Math.sign(r-12),u=d[r]*l+(f?-1:2*a-s);if(i<0)o.addArrow(r,u,i,c++,n);else{d[i]*l<0&&(d[i]=0,d[o.getBarPosition(-l)]-=l);const t=Math.abs(d[i]);o.addArrow(r,u,i,t,n),d[i]+=l}d[r]-=l}}))}function m(t){const[[n,e],[c,s]]=g(t);o.addArrow(n,e,c,s,p)}function y(t){const[[n,e],[c,s]]=g(t);o.addDoubleArrow(n,e,c,s,p)}function w(t){const n=t.split("-"),[[e,c]]=g(n[0]),[s,a]=o.getCheckerCenter(e,c);o.addText(s,a,n[1],p)}const k=t.split(":").slice(10);for(const t of k)switch(t[0]){case"A":m(t);break;case"D":y(t);break;case"P":x=t,o.addPolygon(g(x),p);break;case"T":break;default:b(t)}var x;const C=Math.floor(a[4]/10),M=a[4]%10;C>=1&&C<=6&&M>=1&&M<=6&&(o.addDice(l,C,0),o.addDice(l,M,1)),o.addPipsCount(e,r[e]),o.addPipsCount(c,25*i[c]-r[c]);for(const t of k)if("T"==t[0]){w(t);break}return o.close()}}