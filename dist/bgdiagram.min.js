/*
Backgammon diagram generator
Copyright (c) 2024-2025 Alessandro Scotti
MIT License
*/
const CheckerRadius=25,CheckerSize=50,BorderWidth=2;function BgDiagramBuilder(t){const n=(t=t||{}).swapColors?-1:1,o=250,e=54,c=t.compact?0:25,s=768,i=554+2*c,[a,r]=t.homeOnLeft?[-357,357]:[357,-357],d=[],l="bgdiagram";function u(t){return t*n==1?"white":"black"}function f(t,n){return"number"==typeof n&&(n=u(n)),`${l}__${t}`+(n?" "+n.split(" ").map((n=>`${l}__${t}--${n}`)).join(" "):"")}function h(n){return t.homeOnLeft?(n>12?37:13)-n:n}function $(t,n){let o,e=0,c=248;if(t<0)e=a-15*Math.sign(a),o=-50==t?-1:1;else if(t%25==0)o=t?-1:1,c-=37.5;else{o=(t=h(t))<=12?1:-1,e=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1)+25}return[e,o*(c-50*n)]}function p(t){d.push(t)}function g(t,n,o,e,c,s){const i=20,a=o-t,r=e-n,d=Math.atan2(r,a),l=t+c*i*Math.cos(d),u=n+c*i*Math.sin(d),f=o-s*i*Math.cos(d),h=e-s*i*Math.sin(d),$=f-i*Math.cos(d),p=h-i*Math.sin(d),g=5*Math.sin(d),b=5*-Math.cos(d),m=12.5*Math.sin(d),y=12.5*-Math.cos(d);return[[l-g,u-b],[$-g,p-b],[$-m,p-y],[f,h],[$+m,p+y],[$+g,p+b],[l+g,u+b]]}function b(t,n,o,e,c){p(`<polygon points="${g(t,n,o,e,.1,0).map((t=>t.join(","))).join(" ")}" class="${f("arrow",c)}" />`)}function m(t){const n=t<=12?1:-1,o=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1),e=26*n,c=e+249*n;p(`<polygon points="${o},${c} ${o+50},${c} ${o+25},${e+25*n}" class="${f("point",t%2?"odd":"even")}" />`)}function y(t,n){const o=t<=12?1:-1,[e,c]=$(t,0);w(e,c+50*o*.82,n,"point")}function w(t,n,o,e){p(`<text x="${t}" y="${n}" class="${f("text",e)}">${o}</text>`)}function k(){const n=[];n.push(`viewBox="-386 ${-i/2} 772 ${i}"`),n.push('role="img"'),n.push('aria-label="Diagram of a backgammon game position"'),t.width&&n.push(`width="${t.width}"`.replace("#",772)),t.height&&n.push(`height="${t.height}"`.replace("#",i));const o=t.classNames||[];o.length&&n.push(`class="${o.join(" ")}"`),d.length=0,p(`<svg ${n.join(" ")}>`),function(){const t=384,n=-275;p(`<rect x="-384" y="${-i/2}" width="768" height="${i}" class="${f("background")}"/>`),p(`<rect x="-384" y="-275" width="768" height="550" class="${f("board")}"/>`);for(let t=1;t<=24;t++)m(t);function o(t,n,o,e){p(`<rect x="${t}" y="${n}" width="${o}" height="550" class="${f("board-frame",e)}"/>`)}o(-27,n,e),o(-t,n,54),o(330,n,54),o(-t,n,s,"nofill")}()}return k(),Object.freeze({White:1,Black:-1,getBarPosition:function(t){return 1==t?25:0},getOffPosition:function(t){return 1==t?-25:-50},getCheckerCenter:$,getUsedCssStyles:function(){return new Set(["dominant-baseline","fill","fill-opacity","font-family","font-size","font-weight","stroke","stroke-opacity","stroke-width","text-anchor","transform"])},addArrow:function(t,n,o,e,c){const[s,i]=$(t,n),[a,r]=$(o,e);b(s,i,a,r,c)},addCheckers:function(n,o,e){const c="checker",s=o%25?5:4;for(let i=0;i<e;i++){const[a,r]=$(o,i);if(p(`<circle ${t.addPointInfo?`data-pt="${o}:${i}" `:""}cx="${a}" cy="${r}" r="23.9" class="${f(c,n)}" />`),i==s-1&&e>s){w(a,r,e,c+"--"+u(n));break}}},addCheckersOffboard:function(t,n){const e=a,c=t*o;for(let o=0;o<n;o++)p(`<rect x="${e-22.5}" y="${c-t*(o-1)*14-5}" width="45" height="10" ry="3" class="${f("checker",t)}"/>`);n&&p(`<text x="${e}" y="${c-t*n*14}" class="${f("text","offboard")}">${n}</text>`)},addCrawfordIndicator:function(){const t=r;w(t,-10,"CRAW","crawford"),w(t,10,"FORD","crawford")},addCube:function(t,n,e){const c=Math.round(20),s=r,i=t*(o+50*(e?1:-1)*.3-c);p(`<rect x="${s-c}" y="${i-c}" width="${2*c}" height="${2*c}" ry="4" class="${f("cube")}"/>`),w(s,i,n,"cube")},addDice:function(n,o,e){const c=(t.homeOnLeft?-1:1)*n*(152+50*e+2);function s(t,o){p(`<circle cx="${c+10*t}" cy="${10*o}" r="${50/12}" class="${f("dice-dot",n)}" />`)}p(`<rect x="${c-20}" y="-20" width="40" height="40" ry="6" class="${f("dice",n)}"/>`),1&o&&s(0,0),6&o&&(s(-1,-1),s(1,1)),4&o&&(s(-1,1),s(1,-1)),6==o&&(s(-1,0),s(1,0))},addDoubleArrow:function(t,n,o,e,c){const[s,i]=$(t,n),[a,r]=$(o,e);!function(t,n,o,e,c){const s=(o-t)/2,i=(e-n)/2,a=g(t+s,n+i,t,n,0,0),r=g(t+s,n+i,o,e,0,0);a.pop(),r.pop(),p(`<polygon points="${[...a,...r].map((t=>t.join(","))).join(" ")}" class="${f("arrow",c)}" />`)}(s,i,a,r,c)},addPipsCount:function(t,n){w(0,255*t,n,`pipcount ${u(t)}`)},addPlayerOnTurnIndicator:function(n,o){const e=[a,0,r][o||0],c=n*[289,254.5,150][o||0];if(o){const o=20,s=t.homeOnLeft?-1:1;b(e-s*o,c,e+s*o,c,u(n))}else p(`<circle cx="${e}" cy="${c}" r="10" class="${f("checker","turn "+u(n))}" />`)},addPointNumbers:function(t){for(let n=1;n<=24;n++){const o=h(n);y(o,1==t?o:25-o)}},addPointOverlay:function(t,n){const[o,e]=$(t,0);p(`<rect x="${o-25}" y="${Math.min(e-25,0)}" width="50" height="${273-(o%25?0:25)}" class="${f("point-overlay",n)}" />`)},addPolygon:function(t,n){const o="polygon";p(`<polygon points="${t=t.map((t=>$(t[0],t[1]).join(","))).join(" ")}" class="${f(o,"outer")}" />`),p(`<polygon points="${t}" class="${f(o,n)}" />`)},addScore:function(t,n){w(r,255*t,n,`${u(t)} score${n.length>3?" small":""}`)},addSvg:p,addText:w,close:function(){return p("</svg>"),d.join("")},reset:k})}export class BgDiagram{static newBuilder(t){return BgDiagramBuilder(t)}static getIsValidXgidRegEx(){const t="\\d+(\\.\\d+)?,\\d+(\\.\\d+)?",n="(\\d+|bar)\\/(\\d+|off)(\\*|\\([2-4]\\))?";return`^XGID=[-a-oA-O]{26}:\\d+:-?[01]:-?1:(00|[DBR]|[1-6]{2}):\\d+:\\d+:[0-3]:\\d+:\\d+(:(${`${n}(,${n})*[!?]*`}|${`[AD]${t}-${t}`}|${`P${t}(-${t})*`}|${`T${t}-[^:]+`}))*$`}static fromXgid(t,n){const o=n.builder||BgDiagramBuilder(n),e=o.White,c=o.Black,s="XGID=";t.startsWith(s)&&(t=t.substring(5));const i=t.split(":").slice(10),a={};for(const t of i)if("O"==t[0]){const n=t[1],o=t.substring(2);switch(n){case"n":a.hideNumbers="-"==o;break;case"p":a.hidePipcount="-"==o}}const r=t.split(":").map(Number),d={[e]:0,[c]:0},l={[e]:0,[c]:0},u=new Array(26).fill(0);for(let n=0;n<=25;n++){let s=e,i=t.codePointAt(n)-64;i>0&&(i>15&&(i-=32,s=c),d[s]+=n*i,l[s]+=i,u[n]=i*s,o.addCheckers(s,n,i))}o.addCheckersOffboard(e,15-l[e]),o.addCheckersOffboard(c,15-l[c]);const f=r[3],h=null==n.turnIndicatorMode?n.compact?2:0:n.turnIndicatorMode;o.addPlayerOnTurnIndicator(f,h),!n.compact&&!a.hideNumbers&&o.addPointNumbers(f);const $=r[8];if($>0){const t=n.scoreAsAway?$-r[5]+"a":`${r[5]}⧸${$}`,s=n.scoreAsAway?$-r[6]+"a":`${r[6]}⧸${$}`;o.addScore(e,t),o.addScore(c,s)}const p=r[1]||6,g=r[2];$>0&&r[7]?o.addCrawfordIndicator():o.addCube(g,1<<p,0==$?1:0);const b="annotation";function m(t){return t.substring(1).split("-").map((t=>t.split(",").map(Number)))}function y(t){let n,c=0;const s=t.match(/([!?]+)$/);s&&(n={"??":"blunder","?":"error","?!":"dubious","!":"good","!!":"best"}[s[0]],t=t.slice(0,-s[0].length));t.replace(/\*/g,"").replace(/bar/g,"25").replace(/\/off|\/0/g,`/${o.getOffPosition(f)}`).split(/\s*,\s*|\s+/).forEach((t=>{let s=1;const i=t.indexOf("(");i>0&&(s=parseInt(t.substring(i+1)),t=t.substring(0,i));for(let i=0;i<s;i++){const[a,r]=t.split("/").map((t=>t<0?t:f==e?parseInt(t):25-parseInt(t))),d=a>=1&&a<=24&&r>=1&&r<=24&&Math.sign(r-12)!=Math.sign(a-12),l=u[a]*f+(d?-1:2*i-s);if(r<0)o.addArrow(a,l,r,c++,n);else{u[r]*f<0&&(u[r]=0,u[o.getBarPosition(-f)]-=f);const t=Math.abs(u[r]);o.addArrow(a,l,r,t,n),u[r]+=f}u[a]-=f}}))}function w(t){const[[n,e],[c,s]]=m(t);o.addArrow(n,e,c,s,b)}function k(t){const[[n,e],[c,s]]=m(t);o.addDoubleArrow(n,e,c,s,b)}function x(t){const n=t.split("-"),[[e,c]]=m(n[0]),[s,i]=o.getCheckerCenter(e,c);o.addText(s,i,n[1],b)}for(const t of i)switch(t[0]){case"A":w(t);break;case"D":k(t);break;case"P":C=t,o.addPolygon(m(C),b);break;case"O":case"T":break;default:y(t)}var C;const M=Math.floor(r[4]/10),P=r[4]%10;M>=1&&M<=6&&P>=1&&P<=6&&(o.addDice(f,M,0),o.addDice(f,P,1)),a.hidePipcount||(o.addPipsCount(e,d[e]),o.addPipsCount(c,25*l[c]-d[c]));for(const t of i)"T"==t[0]&&x(t);return o.close()}}