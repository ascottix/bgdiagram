/*
Backgammon diagram generator
Copyright (c) 2024-2025 Alessandro Scotti
MIT License
*/
const CheckerRadius=25,CheckerSize=50,BorderWidth=2;function BgDiagramBuilder(t){const o=(t=t||{}).swapColors?-1:1,n=250,e=54,c=t.compact?0:25,a=768,s=554+2*c,[i,r]=t.homeOnLeft?[-357,357]:[357,-357],d=[],l="bgdiagram";function u(t){return t*o==1?"white":"black"}function f(t,o){return"number"==typeof o&&(o=u(o)),`${l}__${t}`+(o?" "+o.split(" ").map((o=>`${l}__${t}--${o}`)).join(" "):"")}function h(o){return t.homeOnLeft?(o>12?37:13)-o:o}function $(t,o){let n,e=0,c=248;if(t<0)e=i-15*Math.sign(i),n=-50==t?-1:1;else if(t%25==0)n=t?-1:1,c-=25;else{n=(t=h(t))<=12?1:-1,e=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1)+25}return[e,n*(c-50*o)]}function p(t){d.push(t)}function g(t,o,n,e,c,a){const s=20,i=n-t,r=e-o,d=Math.atan2(r,i),l=t+c*s*Math.cos(d),u=o+c*s*Math.sin(d),f=n-a*s*Math.cos(d),h=e-a*s*Math.sin(d),$=f-s*Math.cos(d),p=h-s*Math.sin(d),g=5*Math.sin(d),m=5*-Math.cos(d),b=12.5*Math.sin(d),y=12.5*-Math.cos(d);return[[l-g,u-m],[$-g,p-m],[$-b,p-y],[f,h],[$+b,p+y],[$+g,p+m],[l+g,u+m]]}function m(t){const o=t<=12?1:-1,n=50*(t<=12?6-t:t-19)+29*(t>=7&&t<=18?-1:1),e=26*o,c=e+249*o;p(`<polygon points="${n},${c} ${n+50},${c} ${n+25},${e+25*o}" class="${f("point",t%2?"odd":"even")}" />`)}function b(t,o){const n=t<=12?1:-1,[e,c]=$(t,0);y(e,c+50*n*.82,o,"point")}function y(t,o,n,e){p(`<text x="${t}" y="${o}" class="${f("text",e)}">${n}</text>`)}function w(){const o=[];o.push(`viewBox="-386 ${-s/2} 772 ${s}"`),o.push('role="img"'),o.push('aria-label="Diagram of a backgammon game position"'),t.width&&o.push(`width="${t.width}"`.replace("#",772)),t.height&&o.push(`height="${t.height}"`.replace("#",s));const n=t.classNames||[];o.push(`class="${n.join(" ")}"`),d.length=0,p(`<svg ${o.join(" ")}>`),function(){const t=384,o=-275;p(`<rect x="-384" y="${-s/2}" width="768" height="${s}" class="${f("background")}"/>`),p(`<rect x="-384" y="-275" width="768" height="550" class="${f("board")}"/>`);for(let t=1;t<=24;t++)m(t);function n(t,o,n,e){p(`<rect x="${t}" y="${o}" width="${n}" height="550" class="${f("board-frame",e)}"/>`)}n(-27,o,e),n(-t,o,54),n(330,o,54),n(-t,o,a,"nofill")}()}return w(),Object.freeze({White:1,Black:-1,getBarPosition:function(t){return 1==t?25:0},getOffPosition:function(t){return 1==t?-25:-50},getCheckerCenter:$,getUsedCssStyles:function(){return new Set(["dominant-baseline","fill","fill-opacity","font-family","font-size","font-weight","stroke","stroke-opacity","stroke-width","text-anchor","transform"])},addArrow:function(t,o,n,e,c){const[a,s]=$(t,o),[i,r]=$(n,e);!function(t,o,n,e,c){p(`<polygon points="${g(t,o,n,e,.1,0).map((t=>t.join(","))).join(" ")}" class="${f("arrow",c)}" />`)}(a,s,i,r,c)},addCheckers:function(o,n,e){const c="checker",a=n%25?5:4;for(let s=0;s<e;s++){const[i,r]=$(n,s);if(p(`<circle ${t.addPointInfo?`data-pt="${n}:${s}" `:""}cx="${i}" cy="${r}" r="23.9" class="${f(c,o)}" />`),s==a-1&&e>a){y(i,r,e,c+"--"+u(o));break}}},addCheckersOffboard:function(t,o){const e=i,c=t*n;for(let n=0;n<o;n++)p(`<rect x="${e-22.5}" y="${c-t*(n-1)*14-5}" width="45" height="10" ry="3" class="${f("checker",t)}"/>`);o&&p(`<text x="${e}" y="${c-t*o*14}" class="${f("text","offboard")}">${o}</text>`)},addCrawfordIndicator:function(){const t=r;y(t,-10,"CRAW","crawford"),y(t,10,"FORD","crawford")},addCube:function(t,o,e){const c=Math.round(20),a=r,s=t*(n+50*(e?1:-1)*.3-c);p(`<rect x="${a-c}" y="${s-c}" width="${2*c}" height="${2*c}" ry="4" class="${f("cube")}"/>`),y(a,s,o,"cube")},addDice:function(o,n,e){const c=(t.homeOnLeft?-1:1)*o*(152+50*e+2);function a(t,n){p(`<circle cx="${c+10*t}" cy="${10*n}" r="${50/12}" class="${f("dice-dot",o)}" />`)}p(`<rect x="${c-20}" y="-20" width="40" height="40" ry="6" class="${f("dice",o)}"/>`),1&n&&a(0,0),6&n&&(a(-1,-1),a(1,1)),4&n&&(a(-1,1),a(1,-1)),6==n&&(a(-1,0),a(1,0))},addDoubleArrow:function(t,o,n,e,c){const[a,s]=$(t,o),[i,r]=$(n,e);!function(t,o,n,e,c){const a=(n-t)/2,s=(e-o)/2,i=g(t+a,o+s,t,o,0,0),r=g(t+a,o+s,n,e,0,0);i.pop(),r.pop(),p(`<polygon points="${[...i,...r].map((t=>t.join(","))).join(" ")}" class="${f("arrow",c)}" />`)}(a,s,i,r,c)},addPipsCount:function(t,o){y(0,260*t,o,`pipcount ${u(t)}`)},addPlayerOnTurnIndicator:function(t,o){p(`<circle cx="${o?0:i}" cy="${t*(o?255:289)}" r="10" class="${f("checker","turn "+u(t))}" />`)},addPointNumbers:function(t){for(let o=1;o<=24;o++){const n=h(o);b(n,1==t?n:25-n)}},addPointOverlay:function(t,o){const[n,e]=$(t,0);p(`<rect x="${n-25}" y="${Math.min(e-25,0)}" width="50" height="${273-(n%25?0:25)}" class="${f("point-overlay",o)}" />`)},addPolygon:function(t,o){const n="polygon";p(`<polygon points="${t=t.map((t=>$(t[0],t[1]).join(","))).join(" ")}" class="${f(n,"outer")}" />`),p(`<polygon points="${t}" class="${f(n,o)}" />`)},addScore:function(t,o){y(r,260*t,o,`${u(t)} score${o.length>3?" small":""}`)},addSvg:p,addText:y,close:function(){return p("</svg>"),d.join("")},reset:w})}export class BgDiagram{static newBuilder(t){return BgDiagramBuilder(t)}static fromXgid(t,o){const n=o.builder||BgDiagramBuilder(o),e=n.White,c=n.Black,a="XGID=";t.startsWith(a)&&(t=t.substring(5));const s=t.split(":").map(Number),i={[e]:0,[c]:0},r={[e]:0,[c]:0},d=new Array(26).fill(0);for(let o=0;o<=25;o++){let a=e,s=t.codePointAt(o)-64;s>0&&(s>15&&(s-=32,a=c),i[a]+=o*s,r[a]+=s,d[o]=s*a,n.addCheckers(a,o,s))}n.addCheckersOffboard(e,15-r[e]),n.addCheckersOffboard(c,15-r[c]);const l=s[3];n.addPlayerOnTurnIndicator(l,o.compact?1:0),!o.compact&&n.addPointNumbers(l);const u=s[8];if(u>0&&!o.compact){const t=o.scoreAsAway?u-s[5]+"a":`${s[5]}⧸${u}`,a=o.scoreAsAway?u-s[6]+"a":`${s[6]}⧸${u}`;n.addScore(e,t),n.addScore(c,a)}const f=s[1]||6,h=s[2];u>0&&s[7]?n.addCrawfordIndicator():n.addCube(h,1<<f,o.compact?1:0);const $="annotation";function p(t){return t.substring(1).split("-").map((t=>t.split(",").map(Number)))}function g(t){let o,c=0;const a=t.match(/([!?]+)$/);a&&(o={"??":"blunder","?":"error","?!":"dubious","!":"good","!!":"best"}[a[0]],t=t.slice(0,-a[0].length));t.replace(/\*/g,"").replace(/bar/g,"25").replace(/\/off|\/0/g,`/${n.getOffPosition(l)}`).split(/\s*,\s*|\s+/).forEach((t=>{let a=1;const s=t.indexOf("(");s>0&&(a=parseInt(t.substring(s+1)),t=t.substring(0,s));for(let s=0;s<a;s++){const[i,r]=t.split("/").map((t=>t<0?t:l==e?parseInt(t):25-parseInt(t))),u=i>=1&&i<=24&&r>=1&&r<=24&&Math.sign(r-12)!=Math.sign(i-12),f=d[i]*l+(u?-1:2*s-a);if(r<0)n.addArrow(i,f,r,c++,o);else{d[r]*l<0&&(d[r]=0,d[n.getBarPosition(-l)]-=l);const t=Math.abs(d[r]);n.addArrow(i,f,r,t,o),d[r]+=l}d[i]-=l}}))}function m(t){const[[o,e],[c,a]]=p(t);n.addArrow(o,e,c,a,$)}function b(t){const[[o,e],[c,a]]=p(t);n.addDoubleArrow(o,e,c,a,$)}function y(t){const o=t.split("-"),[[e,c]]=p(o[0]),[a,s]=n.getCheckerCenter(e,c);n.addText(a,s,o[1],$)}const w=t.split(":").slice(10);for(const t of w)switch(console.log(t),t[0]){case"A":m(t);break;case"D":b(t);break;case"P":k=t,n.addPolygon(p(k),$);break;case"T":y(t);break;default:g(t)}var k;const x=Math.floor(s[4]/10),C=s[4]%10;return x>=1&&x<=6&&C>=1&&C<=6&&(n.addDice(l,x,0),n.addDice(l,C,1)),!o.compact&&n.addPipsCount(e,i[e]),!o.compact&&n.addPipsCount(c,25*r[c]-i[c]),n.close()}}